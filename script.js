(truncated for brevity, already in previous answer)